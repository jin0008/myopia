import{r as l,U as C,j as e,u as y,m as K,n as U,o as N,G as T,d as f,q as M,t as W,v as L}from"./index-Ci6lT7C_.js";import{T as O}from"./div-Coub_ivx.js";import{N as Y}from"./not_logged_in-Cu4pqUFC.js";import{a as E,b as G,g as R}from"./static-CztqeYEq.js";import{u as g}from"./useMutation-D6MJQ69v.js";import{T as x}from"./input-dlL0Jff_.js";import{u as B,a as z}from"./healthcare_professional-DU4E_weG.js";import{P as p,a as v}from"./button-DpILQc1R.js";import{d as J,e as Z,a as q,g as $}from"./hospital-DZ8E4L1t.js";import{d as A}from"./styled-components.browser.esm-Db0Q2RpU.js";import{p as V,H as X}from"./hospital_selector-C8USb_JK.js";import{D as b,a as D,b as P,c as _}from"./DialogTitle-C7sNHUiA.js";import"./theme-Dljabw6R.js";import"./DefaultPropsProvider-BgWlOGG4.js";function ve(){const{user:r}=l.useContext(C);return r==null?e.jsx(Y,{}):e.jsxs(O,{children:[e.jsx("h1",{style:{margin:"16px 0"},children:"Your User Profile"}),e.jsxs("p",{children:["Your user id is ",e.jsx("strong",{children:r.id})]}),e.jsx(ee,{}),r.healthcare_professional&&e.jsx(re,{}),r.healthcare_professional?.is_admin&&e.jsx(oe,{})]})}const k=A.div`
  border: 1px solid lightgray;
  padding: 16px;
  border-radius: 16px;
  margin: 16px 0;
`;function ee(){const{user:r}=l.useContext(C),[o,n]=l.useState(!1),[c,i]=l.useState(!1),[t,d]=l.useState(!1),u=y(),j=g({mutationFn:K,onSuccess:()=>{u.invalidateQueries({queryKey:["currentUser"]})},onError:m=>{alert("Google auth failed: "+m.message)}}),s=g({mutationFn:U,onSuccess:()=>{u.invalidateQueries({queryKey:["currentUser"]})},onError:m=>{alert(`Google auth removal failed:
`+m.message)}}),h=g({mutationFn:N,onSuccess:()=>{u.invalidateQueries({queryKey:["currentUser"]})},onError:m=>{alert(`Password auth removal failed:
`+m.message)}});return e.jsxs(k,{children:[e.jsx("h2",{children:"User settings"}),e.jsxs("div",{children:[e.jsx("h3",{children:"Password auth"}),r.password_auth?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["You are using password authentication with username :"," ",e.jsx("strong",{children:r.password_auth.username})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"row",justifyContent:"end",gap:"16px"},children:[e.jsx(p,{onClick:()=>n(!0),children:"Change Password"}),e.jsx(v,{onClick:()=>h.mutate(),children:"Remove password auth"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"You are not using password authentication."}),e.jsx("div",{style:{display:"flex",flexDirection:"row",justifyContent:"end",gap:"16px"},children:e.jsx(p,{onClick:()=>i(!0),children:"Add password auth"})})]})]}),e.jsx(ne,{open:o,onClose:()=>n(!1)}),e.jsx(te,{open:c,onClose:()=>i(!1)}),e.jsxs("div",{children:[e.jsx("h3",{children:"Google auth"}),r.google_auth?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"You are using google authentication."}),e.jsx("div",{style:{display:"flex",flexDirection:"row",justifyContent:"end"},children:e.jsx(v,{onClick:()=>s.mutate(),children:"Remove google auth"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"You are not using google authentication."}),e.jsx("div",{style:{display:"flex",flexDirection:"row",justifyContent:"end"},children:e.jsx(T,{text:"continue_with",onSuccess:m=>{m.credential&&j.mutate(m.credential)}})})]})]}),e.jsxs("div",{children:[e.jsx("h3",{children:"Delete account"}),e.jsx("div",{style:{display:"flex",justifyContent:"end"},children:e.jsx(v,{style:{backgroundColor:"red"},onClick:()=>d(!0),children:"Delete account"})}),e.jsx(se,{open:t,onClose:()=>d(!1)})]})]})}function se({open:r,onClose:o}){const n=y(),c=g({mutationFn:L,onSuccess:()=>{n.invalidateQueries({queryKey:[]})}}),i=f({queryKey:["hospital","member"],queryFn:q}),{user:t}=l.useContext(C),d=t.healthcare_professional?.is_admin&&i.data?.filter(u=>u.approved&&u.is_admin).length===1;return e.jsxs(b,{open:r,onClose:o,fullWidth:!0,children:[e.jsx(D,{children:"Delete account"}),e.jsxs(P,{children:[e.jsx("p",{style:{color:"red"},children:"Warning: This action is irreversible."}),d&&e.jsxs("p",{style:{color:"red"},children:["Warning: You are the only admin in this hospital. If you delete your account, there will be no admin in this hospital.",e.jsx("br",{}),"We recommend you to add another admin before deleting your account."]})]}),e.jsxs(_,{children:[e.jsx(p,{onClick:o,children:"Cancel"}),e.jsx(v,{onClick:()=>{c.mutate(),o()},children:"Delete"})]})]})}function te({open:r,onClose:o}){const n=l.useRef(""),[c,i]=l.useState(""),[t,d]=l.useState(""),u=y(),j=g({mutationFn:({username:h,password:m})=>W(h,m),onSuccess:()=>{u.invalidateQueries({queryKey:["currentUser"]}),o()},onError:h=>{alert("Add password auth failed: "+h.message)}}),s=()=>{if(c!==t){alert("Password and confirm password does not match");return}j.mutate({username:n.current,password:c})};return e.jsxs(b,{open:r,onClose:o,fullWidth:!0,children:[e.jsx(D,{children:"Add password auth"}),e.jsxs(P,{children:[e.jsxs("label",{children:["Username:",e.jsx(x,{onChange:h=>n.current=h.target.value})]}),e.jsxs("label",{children:["Password:",e.jsx(x,{autoComplete:"new-password",type:"password",onChange:h=>i(h.target.value)})]}),e.jsxs("label",{children:["Confirm password:",e.jsx(x,{autoComplete:"new-password",type:"password",onChange:h=>d(h.target.value),style:{borderColor:c!==t?"red":void 0}})]})]}),e.jsxs(_,{children:[e.jsx(p,{onClick:o,children:"Cancel"}),e.jsx(p,{onClick:s,children:"Confirm"})]})]})}function ne({open:r,onClose:o}){const[n,c]=l.useState(""),[i,t]=l.useState(""),d=y(),u=g({mutationFn:M,onSuccess:()=>{d.invalidateQueries({queryKey:["currentUser"]}),alert("Password changed"),o()},onError:s=>{alert("Password change failed: "+s.message)}}),j=()=>{if(n!==i){alert("New password and confirm password does not match");return}u.mutate(n)};return e.jsxs(b,{open:r,onClose:o,fullWidth:!0,children:[e.jsx(D,{children:"Change password"}),e.jsxs(P,{children:[e.jsxs("label",{children:["New password:",e.jsx(x,{type:"password",onChange:s=>c(s.target.value)})]}),e.jsxs("label",{children:["Confirm new password:",e.jsx(x,{type:"password",onChange:s=>t(s.target.value),style:{borderColor:n!==i?"red":void 0}})]})]}),e.jsxs(_,{children:[e.jsx(p,{onClick:o,children:"Cancel"}),e.jsx(p,{onClick:j,children:"Confirm"})]})]})}function re(){const{user:r}=l.useContext(C),o=f({queryKey:["ethnicity"],queryFn:E,staleTime:1/0,gcTime:1/0}),n=f({queryKey:["instrument"],queryFn:G,staleTime:1/0,gcTime:1/0}),c=y(),i=g({mutationFn:B,onSuccess:()=>{c.invalidateQueries({queryKey:["currentUser"]})}}),[t,d]=l.useState(!1),u=f({queryKey:["hospital","member"],queryFn:q}),j=r.healthcare_professional.is_admin&&u.data?.filter(s=>s.approved&&s.is_admin).length===1;return e.jsxs(k,{children:[e.jsx("h2",{children:"Healthcare professional settings"}),e.jsxs("div",{style:{display:"flex",flexDirection:"row",gap:"16px",alignItems:"center"},children:[e.jsxs("p",{children:["Your hospital is"," ",e.jsxs("strong",{children:[r.healthcare_professional.hospital.name,"(Code :"," ",r.healthcare_professional.hospital.code,")"]})]}),e.jsx(p,{onClick:()=>d(!0),children:"Change"}),e.jsx(ie,{open:t,onClose:()=>d(!1)})]}),j&&e.jsxs("p",{style:{color:"red"},children:["Warning: You are the only admin in this hospital. If you change your hospital, there will be no admin in this hospital.",e.jsx("br",{}),"We recommend you to add another admin before changing hospital."]}),e.jsxs("label",{children:["Role:",e.jsx(x,{as:"select",value:r.healthcare_professional.role,onChange:s=>{i.mutate({role:s.target.value})},children:V.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("label",{children:["Default ethnicity:",e.jsxs(x,{as:"select",value:r.healthcare_professional.default_ethnicity_id??"",onChange:s=>{i.mutate({default_ethnicity_id:s.target.value||null})},children:[e.jsx("option",{value:"",children:"(None)"}),o.data?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:["Default instrument:",e.jsxs(x,{as:"select",value:r.healthcare_professional.default_instrument_id??"",onChange:s=>{i.mutate({default_instrument_id:s.target.value||null})},children:[e.jsx("option",{value:"",children:"(None)"}),n.data?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})]})}function ie({open:r,onClose:o}){const[n,c]=l.useState(!1),[i,t]=l.useState(""),d=l.useRef(""),[u,j]=l.useState(""),s=f({queryKey:["country"],queryFn:R,staleTime:1/0,gcTime:1/0}),h=f({queryKey:["hospital"],queryFn:$}),m=y();l.useEffect(()=>{if(s.isSuccess){const a=s.data?.[0];j(a?.id)}},[s.isSuccess]);const I=g({mutationFn:z,onSuccess:()=>{m.invalidateQueries({queryKey:["currentUser"]}),o()}}),w=h.data?.find(a=>a.code===i)?.id,F=()=>{if(n){if(!/^[a-zA-Z0-9]{1,10}$/.test(i)){alert("Invalid hospital code");return}if(!d.current){alert("Missing field: hospital name");return}if(w!=null){alert("Hospital code already exists");return}}if(!n&&w==null){alert("Hospital not found");return}const a=n?{name:d.current,country_id:u,code:i}:{id:h.data.find(Q=>Q.code===i)?.id};I.mutate(a)},[H,S]=l.useState(!1);return e.jsxs(b,{open:r,onClose:o,fullWidth:!0,children:[e.jsx(D,{children:"Change hospital"}),e.jsxs(P,{children:[e.jsxs("label",{children:["Join existing hospital",e.jsx("input",{type:"radio",checked:!n,onChange:a=>c(!a.target.checked)})]}),e.jsx("br",{}),e.jsxs("label",{children:["Register new hospital",e.jsx("input",{type:"radio",checked:n,onChange:a=>c(a.target.checked)})]}),e.jsx("div",{style:{height:"16px"}}),n?e.jsxs("div",{children:[e.jsxs("label",{children:["Hospital name:",e.jsx(x,{placeholder:"Hospital name",onChange:a=>d.current=a.target.value})]}),e.jsxs("label",{children:["Hospital country:",e.jsx(x,{as:"select",onChange:a=>j(a.target.value),children:s.data?.map(a=>e.jsxs("option",{value:a.id,children:[a.name,"(",a.code,")"]},a.id))})]})]}):null,e.jsxs("label",{children:["Hospital code:",e.jsx(x,{value:i,onChange:a=>t(a.target.value),style:{borderColor:n&&w!=null||!n&&w==null?"red":void 0}})]}),!n&&e.jsx(p,{onClick:()=>S(!0),children:"Select hospital"}),e.jsx(X,{open:H,onClose:()=>S(!1),onSelect:a=>{t(a.code),S(!1)}})]}),e.jsxs(_,{children:[e.jsx(p,{onClick:F,children:"Confirm"}),e.jsx(p,{onClick:o,children:"Cancel"})]})]})}const ae=A.table`
  text-align: center;
  & td {
    padding: 8px;
  }
`;function oe(){const r=f({queryKey:["hospital","member"],queryFn:q}),{user:o}=l.useContext(C),n=y(),c=g({mutationFn:J,onSuccess:()=>{n.invalidateQueries({queryKey:["hospital","member"]})}}),i=g({mutationFn:({userId:t,data:d})=>Z(t,d),onSuccess:()=>{n.invalidateQueries({queryKey:["hospital","member"]})}});return e.jsxs(k,{children:[e.jsx("h2",{children:"Hospital admin settings"}),e.jsx("h3",{children:"Member list"}),e.jsxs(ae,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User ID"}),e.jsx("th",{children:"name"}),e.jsx("th",{children:"approve"}),e.jsx("th",{children:"reject/kick"}),e.jsx("th",{children:"admin"})]})}),e.jsx("tbody",{children:r.data?.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.user_id}),e.jsx("td",{children:t.name}),e.jsx("td",{children:t.approved?"Approved":e.jsx(p,{onClick:()=>i.mutate({userId:t.user_id,data:{approved:!0}}),children:"Approve"})}),e.jsx("td",{children:o.id===t.user_id?"You":t.is_admin?e.jsx(e.Fragment,{}):e.jsx(p,{onClick:()=>c.mutate(t.user_id),children:t.approved?"Kick":"Reject"})}),e.jsx("td",{children:t.is_admin?"Is admin":t.approved?e.jsx(p,{onClick:()=>{confirm(`Admins can approve new member as well as kick/reject non-admin members and can't be kicked.
Are you sure you want to set this user as admin?`)&&i.mutate({userId:t.user_id,data:{is_admin:!0}})},children:"Set as admin"}):e.jsx(e.Fragment,{})})]},t.user_id))})]})]})}export{ve as default};
